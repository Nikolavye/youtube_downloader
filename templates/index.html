<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频音频下载器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            animation: backgroundShift 10s ease-in-out infinite;
        }
        
        @keyframes backgroundShift {
            0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
            50% { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: headerPulse 4s ease-in-out infinite;
        }
        
        @keyframes headerPulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(180deg); }
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            position: relative;
            z-index: 1;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .download-form {
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        /* 下载器选择样式 */
        .downloader-selector {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #c3e6cb;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .downloader-selector:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .downloader-title {
            font-weight: bold;
            color: #155724;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .downloader-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .downloader-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 15px 20px;
            background: white;
            border: 2px solid #28a745;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 180px;
            position: relative;
            overflow: hidden;
            flex: 1;
        }
        
        .downloader-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(40, 167, 69, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .downloader-item:hover::before {
            left: 100%;
        }
        
        .downloader-item:hover {
            border-color: #20c997;
            background: #f8fff9;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        
        .downloader-item input[type="radio"] {
            display: none;
        }
        
        .downloader-custom {
            width: 22px;
            height: 22px;
            border: 3px solid #28a745;
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
            background: white;
            transition: all 0.3s ease;
        }
        
        .downloader-item input[type="radio"]:checked + .downloader-custom {
            border-color: #20c997;
            background: #20c997;
            animation: downloaderPulse 0.4s ease;
        }
        
        @keyframes downloaderPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .downloader-item input[type="radio"]:checked + .downloader-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: downloaderAppear 0.2s ease;
        }
        
        @keyframes downloaderAppear {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .downloader-content {
            flex: 1;
        }
        
        .downloader-name {
            font-weight: bold;
            color: #155724;
            font-size: 15px;
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }
        
        .downloader-desc {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .downloader-item input[type="radio"]:checked ~ .downloader-content .downloader-name {
            color: #20c997;
        }
        
        .downloader-status {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(32, 201, 151, 0.1);
            border-radius: 6px;
            border-left: 3px solid #20c997;
            font-size: 12px;
            color: #155724;
        }
        
        /* 下载选项样式 */
        .download-options {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #dee2e6;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .download-options:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .option-group {
            margin-bottom: 20px;
        }
        
        .option-group:last-child {
            margin-bottom: 0;
        }
        
        .option-label {
            display: block;
            font-weight: bold;
            color: #495057;
            margin-bottom: 12px;
            font-size: 15px;
        }
        
        /* 单选按钮组 */
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 12px 20px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }
        
        .radio-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .radio-item:hover::before {
            left: 100%;
        }
        
        .radio-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .radio-item input[type="radio"] {
            display: none;
        }
        
        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            margin-right: 10px;
            position: relative;
            background: white;
            transition: all 0.3s ease;
        }
        
        .radio-item input[type="radio"]:checked + .radio-custom {
            border-color: #667eea;
            background: #667eea;
            animation: radioPulse 0.3s ease;
        }
        
        @keyframes radioPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .radio-item input[type="radio"]:checked + .radio-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: radioAppear 0.2s ease;
        }
        
        @keyframes radioAppear {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .radio-item input[type="radio"]:checked ~ .radio-text {
            color: #667eea;
            font-weight: bold;
        }
        
        .radio-text {
            font-size: 14px;
            color: #495057;
            transition: all 0.3s ease;
        }
        
        /* 选择框样式 */
        .select-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #495057;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .select-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .select-input:hover {
            border-color: #adb5bd;
        }
        
        /* 音频额外选项 */
        .audio-extras {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .checkbox-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(40, 167, 69, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .checkbox-item:hover::before {
            left: 100%;
        }
        
        .checkbox-item:hover {
            border-color: #28a745;
            background: #f8fff9;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }
        
        .checkbox-item input[type="checkbox"] {
            display: none;
        }
        
        .checkbox-custom {
            width: 18px;
            height: 18px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            background: white;
            transition: all 0.3s ease;
        }
        
        .checkbox-item input[type="checkbox"]:checked + .checkbox-custom {
            border-color: #28a745;
            background: #28a745;
            animation: checkboxPulse 0.3s ease;
        }
        
        @keyframes checkboxPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .checkbox-item input[type="checkbox"]:checked + .checkbox-custom::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            color: white;
            font-size: 12px;
            font-weight: bold;
            transform: translate(-50%, -50%);
            animation: checkmarkAppear 0.2s ease;
        }
        
        @keyframes checkmarkAppear {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0) rotate(-45deg); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }
        
        .checkbox-item input[type="checkbox"]:checked ~ .checkbox-text {
            color: #28a745;
            font-weight: bold;
        }
        
        .checkbox-text {
            font-size: 14px;
            color: #495057;
            transition: all 0.3s ease;
        }
        
        /* 格式信息 */
        .format-info {
            margin-top: 15px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            border-left: 4px solid #667eea;
            position: relative;
            overflow: hidden;
        }
        
        .format-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .format-info:hover::before {
            transform: translateX(100%);
        }
        
        .format-info small {
            color: #495057;
            font-size: 13px;
            line-height: 1.4;
            position: relative;
            z-index: 1;
        }
        
        /* 质量选择器样式 */
        .audio-quality-container {
            margin-top: 15px;
        }
        
        .quality-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #495057;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .quality-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .url-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .download-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }
        
        .download-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .download-btn:hover::before {
            left: 100%;
        }
        
        .download-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .download-btn:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        .download-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .download-btn:disabled::before {
            display: none;
        }
        
        /* 进度容器样式 */
        .progress-container {
            display: none;
            margin: 25px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px solid #dee2e6;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.05), transparent);
            animation: progressShine 2s ease-in-out infinite;
        }
        
        @keyframes progressShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .progress-container.show {
            display: block !important;
            animation: slideInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .video-title {
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            font-size: 16px;
            padding: 15px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            border-left: 4px solid #667eea;
            position: relative;
            z-index: 1;
        }
        
        .progress-main {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .progress-percentage {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            color: #333;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            animation: numberPulse 1s ease-in-out infinite;
        }
        
        @keyframes numberPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* 进度条容器 */
        .progress-bar-container {
            width: 100%;
            height: 35px;
            background: #e9ecef;
            border-radius: 17px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* 进度条填充 */
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(45deg, #28a745, #20c997, #17a2b8);
            background-size: 400% 400%;
            border-radius: 17px;
            position: relative;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            animation: gradientFlow 3s ease-in-out infinite;
        }
        
        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* 进度条上的文字 */
        .progress-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            z-index: 10;
            font-size: 14px;
        }
        
        /* 进度详情网格 */
        .progress-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }
        
        .progress-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .progress-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .progress-item:hover::before {
            left: 100%;
        }
        
        .progress-item:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .progress-item strong {
            display: block;
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }
        
        .progress-item span {
            color: #666;
            font-size: 12px;
            position: relative;
            z-index: 1;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .message::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .message.show {
            display: block !important;
            animation: messageSlideIn 0.3s ease;
        }
        
        .message.show::before {
            left: 100%;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .message.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .downloads-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #333;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .refresh-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #6c757d, #5a6268);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .performance-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .test-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .refresh-btn::before,
        .performance-btn::before,
        .test-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .refresh-btn:hover::before,
        .performance-btn:hover::before,
        .test-btn:hover::before {
            left: 100%;
        }
        
        .refresh-btn:hover,
        .performance-btn:hover,
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
        
        .performance-btn:hover {
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .test-btn:hover {
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        
        .downloads-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .download-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f9f9f9, #ffffff);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .download-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .download-item:hover::before {
            left: 100%;
        }
        
        .download-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-color: #667eea;
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
            position: relative;
            z-index: 1;
        }
        
        .file-name {
            font-weight: bold;
            margin-bottom: 8px;
            word-break: break-word;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .file-type-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: badgePulse 2s ease-in-out infinite;
        }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .file-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #666;
        }
        
        .download-link {
            padding: 10px 20px;
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 15px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .download-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
            z-index: -1;
        }
        
        .download-link:hover::before {
            left: 100%;
        }
        
        .download-link:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
            text-decoration: none;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            position: relative;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: loadingSpin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes loadingSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* 过滤器样式 */
        .filter-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .filter-label {
            font-weight: bold;
            color: #495057;
            font-size: 14px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #495057;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .download-item {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .download-link {
                margin-left: 0;
                text-align: center;
            }
            
            .progress-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            /* 移动端下载选项 */
            .download-options {
                padding: 20px;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .radio-item {
                min-width: auto;
                width: 100%;
                justify-content: center;
            }
            
            .audio-extras {
                flex-direction: column;
                gap: 10px;
            }
            
            .checkbox-item {
                width: 100%;
                justify-content: center;
            }
            
            .option-label {
                font-size: 14px;
            }
            
            .select-input, .quality-select {
                font-size: 16px; /* 防止iOS缩放 */
            }

            .filter-container {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .filter-select {
                width: 100%;
            }

            /* 移动端下载器选择 */
            .downloader-options {
                flex-direction: column;
                gap: 12px;
            }

            .downloader-item {
                min-width: auto;
                flex: none;
            }
        }

        /* 性能状态弹窗 */
        .performance-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .performance-modal.show {
            display: flex !important;
        }

        .performance-content {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .performance-header {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
        }

        .performance-header h3 {
            margin: 0;
            font-size: 1.5em;
            color: #28a745;
        }

        .performance-stats {
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-weight: bold;
            color: #495057;
        }

        .stat-value {
            color: #28a745;
            font-weight: bold;
        }

        .performance-features {
            margin-bottom: 20px;
        }

        .feature-item {
            padding: 8px 12px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 6px;
            margin-bottom: 8px;
            color: #155724;
            border-left: 3px solid #28a745;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 视频音频下载器</h1>
            <p>🚀 性能优化版 (可选下载器) • 原始格式下载 • 8线程并发 • 智能重试 • 极速无损</p>
        </div>
        
        <div class="content">
            <div class="download-form">
                <div class="input-group">
                    <input type="text" id="urlInput" class="url-input" placeholder="请输入视频URL..." />
                    <button id="downloadBtn" class="download-btn">🎯 下载原始音频</button>
                </div>
                
                <!-- 下载器选择区域 -->
                <div class="downloader-selector">
                    <div class="downloader-title">
                        🔧 选择下载器
                    </div>
                    <div class="downloader-options">
                        <label class="downloader-item">
                            <input type="radio" name="downloaderType" value="ytdlp" checked>
                            <span class="downloader-custom"></span>
                            <div class="downloader-content">
                                <div class="downloader-name">🚀 yt-dlp 内置优化版</div>
                                <div class="downloader-desc">高度优化的内置下载器，确保进度显示正常，适合大多数场景</div>
                            </div>
                        </label>
                        <label class="downloader-item">
                            <input type="radio" name="downloaderType" value="aria2c">
                            <span class="downloader-custom"></span>
                            <div class="downloader-content">
                                <div class="downloader-name">⚡ aria2c 外部加速器</div>
                                <div class="downloader-desc">极速多线程下载器，速度更快但进度显示可能不稳定</div>
                            </div>
                        </label>
                    </div>
                    <div id="downloaderStatus" class="downloader-status">
                        正在检测下载器状态...
                    </div>
                </div>
                
                <!-- 下载选项区域 -->
                <div class="download-options">
                    <div class="option-group">
                        <label class="option-label">📥 下载类型</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="downloadType" value="audio" checked>
                                <span class="radio-custom"></span>
                                <span class="radio-text">🎵 音频</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="downloadType" value="video">
                                <span class="radio-custom"></span>
                                <span class="radio-text">🎥 视频</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 视频质量选项 (默认隐藏) -->
                    <div id="videoOptions" class="option-group" style="display: none;">
                        <label class="option-label">🎬 视频质量</label>
                        <select id="videoQuality" class="select-input">
                            <option value="720p" selected>📺 720p (推荐)</option>
                            <option value="480p">📱 480p</option>
                            <option value="best">🔥 最佳质量</option>
                        </select>
                        
                        <div class="video-format-container" style="margin-top: 15px;">
                            <label class="option-label">📼 视频格式</label>
                            <select id="videoFormat" class="select-input">
                                <option value="original" selected>🎯 原始格式 (webm/mp4等，速度最快)</option>
                                <option value="mp4">📱 MP4 (通用兼容性最好)</option>
                                <option value="mkv">🎬 MKV (高质量容器)</option>
                                <option value="avi">📺 AVI (传统格式)</option>
                            </select>
                        </div>
                        
                        <div class="format-info">
                            <small id="videoFormatInfo">🎯 <strong>原始格式：</strong>直接下载源文件格式，速度最快，无质量损失<br>
                            📱 <strong>兼容性：</strong>MP4兼容性最好，适合各种设备播放<br>
                            ⚡ <strong>提示：</strong>选择原始格式可获得最快下载速度</small>
                        </div>
                    </div>
                    
                    <!-- 音频选项 -->
                    <div id="audioOptions" class="option-group">
                        <div class="audio-format">
                            <label class="option-label">🎼 音频格式</label>
                            <select id="audioFormat" class="select-input">
                                <option value="original" selected>🎯 原始格式 (保持源文件格式，推荐)</option>
                                <option value="mp3">🎵 MP3 (兼容性最好)</option>
                                <option value="m4a">🎧 M4A (苹果设备优化)</option>
                                <option value="wav">📀 WAV (无压缩)</option>
                            </select>
                        </div>
                        
                        <div id="audioQualityContainer" class="audio-quality-container">
                            <label class="option-label">🎚️ 音频质量</label>
                            <select id="audioQuality" class="quality-select">
                                <option value="192" selected>192 kbps (推荐)</option>
                                <option value="128">128 kbps (标准)</option>
                                <option value="256">256 kbps (高质量)</option>
                                <option value="320">320 kbps (最高质量)</option>
                                <option value="0">无损质量</option>
                            </select>
                        </div>
                        
                        <div class="audio-extras">
                            <label class="checkbox-item">
                                <input type="checkbox" id="embedMetadata">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">📝 包含元数据</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="embedThumbnail">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">🖼️ 包含封面</span>
                            </label>
                        </div>
                        
                        <div class="format-info">
                            <small id="formatInfoText">🎯 <strong>原始格式模式：</strong>将下载音频的原始格式，不进行任何转换<br>
                            ⚡ <strong>优势：</strong>下载速度更快，保持原始音质，文件大小最优<br>
                            📝 <strong>注意：</strong>格式可能为webm、m4a等，具体取决于源网站</small>
                        </div>
                    </div>
                </div>
                
                <!-- 进度显示区域 -->
                <div id="progressContainer" class="progress-container">
                    <div id="videoTitle" class="video-title"></div>
                    <div class="progress-main">
                        <div id="progressPercentage" class="progress-percentage">0%</div>
                        <div class="progress-bar-container">
                            <div id="progressBarFill" class="progress-bar-fill"></div>
                            <div id="progressBarText" class="progress-bar-text">准备中...</div>
                        </div>
                    </div>
                    <div class="progress-details">
                        <div class="progress-item">
                            <strong id="progressSize">0 B / 0 B</strong>
                            <span>已下载</span>
                        </div>
                        <div class="progress-item">
                            <strong id="progressSpeed">0 B/s</strong>
                            <span>下载速度</span>
                        </div>
                        <div class="progress-item">
                            <strong id="progressEta">--</strong>
                            <span>剩余时间</span>
                        </div>
                    </div>
                </div>
                
                <div id="message" class="message"></div>
            </div>
            
            <div class="downloads-section">
                <div class="section-header">
                    <h3 class="section-title">📁 已下载文件</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="performanceBtn" class="performance-btn">🚀 性能状态</button>
                        <button id="testAria2cBtn" class="test-btn">🔧 测试aria2c</button>
                        <button id="refreshBtn" class="refresh-btn">刷新列表</button>
                    </div>
                </div>
                
                <!-- 文件类型过滤器 -->
                <div class="filter-container">
                    <span class="filter-label">🔍 显示文件类型：</span>
                    <select id="fileTypeFilter" class="filter-select">
                        <option value="all">🗂️ 全部文件</option>
                        <option value="audio_converted">🎵 转换后音频</option>
                        <option value="audio_original">🎯 原始音频</option>
                        <option value="video_converted">🎬 转换后视频</option>
                        <option value="video_original">🎯 原始视频</option>
                    </select>
                </div>
                
                <div id="downloadsList" class="downloads-list">
                    <div class="loading">正在加载下载列表...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 性能状态弹窗 -->
    <div id="performanceModal" class="performance-modal">
        <div class="performance-content">
            <button class="close-btn" onclick="hidePerformanceModal()">&times;</button>
            <div class="performance-header">
                <h3>🚀 性能优化状态</h3>
                <p>当前系统运行在高性能模式</p>
            </div>
            
            <div class="performance-stats">
                <div class="stat-item">
                    <span class="stat-label">🧵 并发片段下载</span>
                    <span class="stat-value" id="concurrentFragments">8 线程</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">🔄 智能重试次数</span>
                    <span class="stat-value" id="retryCount">15 次</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">💾 缓冲区大小</span>
                    <span class="stat-value" id="bufferSize">16KB</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">📦 HTTP块大小</span>
                    <span class="stat-value" id="chunkSize">10MB</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">⏱️ 请求间隔</span>
                    <span class="stat-value" id="sleepRequests">0.5秒</span>
                </div>
            </div>
            
            <div class="performance-features">
                <h4 style="color: #333; margin-bottom: 15px;">✨ 启用的优化特性</h4>
                <div id="optimizationFeatures">
                    <div class="feature-item">🚀 并发片段下载 (8线程)</div>
                    <div class="feature-item">⚡ 智能重试策略</div>
                    <div class="feature-item">🌐 网络优化调优</div>
                    <div class="feature-item">🎯 原始格式极速下载</div>
                    <div class="feature-item">🔄 User-Agent轮换</div>
                    <div class="feature-item">💾 缓冲区优化</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VideoDownloader {
            constructor() {
                this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.socket = null;
                this.isDownloading = false;
                this.downloadTimeout = null;
                this.allFiles = []; // 存储所有文件数据
                
                this.initElements();
                this.initSocket();
                this.bindEvents();
                this.loadDownloadsList();
                this.initializeState();
                this.checkDownloaderStatus(); // 检查下载器状态
                
                console.log('VideoDownloader initialized with session:', this.sessionId);
            }
            
            initializeState() {
                // 确保页面加载时处于正确状态
                this.resetDownloadState();
                this.hideProgressContainer();
                this.handleDownloadTypeChange('audio'); // 默认为音频
                this.handleAudioFormatChange('original'); // 默认为原始格式
                this.handleVideoFormatChange('original'); // 默认为原始格式
                this.handleDownloaderChange('ytdlp'); // 默认为yt-dlp
            }
            
            initElements() {
                this.urlInput = document.getElementById('urlInput');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.progressContainer = document.getElementById('progressContainer');
                this.videoTitle = document.getElementById('videoTitle');
                this.progressBarFill = document.getElementById('progressBarFill');
                this.progressBarText = document.getElementById('progressBarText');
                this.progressPercentage = document.getElementById('progressPercentage');
                this.progressSize = document.getElementById('progressSize');
                this.progressSpeed = document.getElementById('progressSpeed');
                this.progressEta = document.getElementById('progressEta');
                this.message = document.getElementById('message');
                this.downloadsList = document.getElementById('downloadsList');
                this.refreshBtn = document.getElementById('refreshBtn');
                this.performanceBtn = document.getElementById('performanceBtn');
                this.testAria2cBtn = document.getElementById('testAria2cBtn');
                
                // 下载器选择元素
                this.downloaderTypeRadios = document.querySelectorAll('input[name="downloaderType"]');
                this.downloaderStatus = document.getElementById('downloaderStatus');
                
                // 选项元素
                this.downloadTypeRadios = document.querySelectorAll('input[name="downloadType"]');
                this.videoOptions = document.getElementById('videoOptions');
                this.audioOptions = document.getElementById('audioOptions');
                this.videoQuality = document.getElementById('videoQuality');
                this.videoFormat = document.getElementById('videoFormat');
                this.videoFormatInfo = document.getElementById('videoFormatInfo');
                this.audioFormat = document.getElementById('audioFormat');
                this.audioQuality = document.getElementById('audioQuality');
                this.audioQualityContainer = document.getElementById('audioQualityContainer');
                this.embedMetadata = document.getElementById('embedMetadata');
                this.embedThumbnail = document.getElementById('embedThumbnail');
                this.formatInfoText = document.getElementById('formatInfoText');
                
                // 过滤器元素
                this.fileTypeFilter = document.getElementById('fileTypeFilter');
            }
            
            initSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    console.log('Connected to server');
                    this.socket.emit('join_session', {session_id: this.sessionId});
                });
                
                this.socket.on('download_progress', (data) => {
                    console.log('Received progress:', data);
                    this.updateProgress(data);
                });
                
                this.socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                });
            }
            
            bindEvents() {
                this.downloadBtn.addEventListener('click', () => this.startDownload());
                this.refreshBtn.addEventListener('click', () => this.loadDownloadsList());
                this.performanceBtn.addEventListener('click', () => this.showPerformanceModal());
                this.testAria2cBtn.addEventListener('click', () => this.testAria2c());
                
                this.urlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isDownloading) {
                        this.startDownload();
                    }
                });
                
                this.urlInput.addEventListener('input', () => {
                    this.downloadBtn.disabled = !this.urlInput.value.trim() || this.isDownloading;
                });
                
                // 下载器类型切换事件
                this.downloaderTypeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.handleDownloaderChange(e.target.value);
                    });
                });
                
                // 下载类型切换事件
                this.downloadTypeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.handleDownloadTypeChange(e.target.value);
                    });
                });
                
                // 音频格式切换事件
                this.audioFormat.addEventListener('change', (e) => {
                    this.handleAudioFormatChange(e.target.value);
                });
                
                // 视频格式切换事件
                this.videoFormat.addEventListener('change', (e) => {
                    this.handleVideoFormatChange(e.target.value);
                });
                
                // 文件类型过滤器事件
                this.fileTypeFilter.addEventListener('change', () => {
                    this.filterAndDisplayFiles();
                });
            }
            
            handleDownloaderChange(type) {
                const statusMessages = {
                    'ytdlp': '✅ yt-dlp内置优化版已选择 - 高度优化，确保进度显示正常',
                    'aria2c': '⚡ aria2c外部加速器已选择 - 极速下载，进度显示可能不稳定'
                };
                
                this.downloaderStatus.textContent = statusMessages[type] || '正在检测下载器状态...';
                
                // 如果选择aria2c，可以进行快速检测
                if (type === 'aria2c') {
                    this.quickCheckAria2c();
                }
            }
            
            async quickCheckAria2c() {
                try {
                    const response = await fetch('/api/test-aria2c');
                    const data = await response.json();
                    
                    if (data.status === 'not_found') {
                        this.downloaderStatus.textContent = '⚠️ aria2c未安装，将自动回退到yt-dlp内置下载器';
                        this.downloaderStatus.style.color = '#fd7e14';
                    } else if (data.status === 'available_but_not_used' || data.status === 'working') {
                        this.downloaderStatus.textContent = '✅ aria2c可用 - 极速多线程下载模式';
                        this.downloaderStatus.style.color = '#28a745';
                    } else {
                        this.downloaderStatus.textContent = '⚠️ aria2c检测异常，建议使用yt-dlp内置下载器';
                        this.downloaderStatus.style.color = '#fd7e14';
                    }
                } catch (error) {
                    this.downloaderStatus.textContent = '⚠️ 下载器检测失败，使用默认设置';
                    this.downloaderStatus.style.color = '#fd7e14';
                }
            }
            
            async checkDownloaderStatus() {
                try {
                    const response = await fetch('/api/test-aria2c');
                    const data = await response.json();
                    
                    let statusText = '';
                    if (data.status === 'not_found') {
                        statusText = '❌ aria2c未安装，仅可使用yt-dlp内置下载器';
                    } else if (data.status === 'available_but_not_used' || data.status === 'working') {
                        statusText = '✅ 两种下载器均可用，请选择您偏好的下载器';
                    } else {
                        statusText = '⚠️ aria2c状态异常，建议使用yt-dlp内置下载器';
                    }
                    
                    this.downloaderStatus.textContent = statusText;
                } catch (error) {
                    this.downloaderStatus.textContent = '⚠️ 下载器状态检测失败';
                }
            }
            
            handleDownloadTypeChange(type) {
                if (type === 'video') {
                    this.videoOptions.style.display = 'block';
                    this.audioOptions.style.display = 'none';
                } else {
                    this.videoOptions.style.display = 'none';
                    this.audioOptions.style.display = 'block';
                }
                
                const icon = type === 'video' ? '🎥' : '🎯';
                const text = type === 'video' ? '下载视频' : '下载原始音频';
                this.downloadBtn.innerHTML = `${icon} ${text}`;
            }
            
            handleAudioFormatChange(format) {
                if (format === 'original') {
                    // 原始格式时隐藏质量选择和额外选项
                    this.audioQualityContainer.style.display = 'none';
                    document.querySelector('.audio-extras').style.display = 'none';
                    this.formatInfoText.innerHTML = `
                        🎯 <strong>原始格式模式：</strong>将下载音频的原始格式，不进行任何转换<br>
                        ⚡ <strong>优势：</strong>下载速度更快，保持原始音质，文件大小最优<br>
                        📝 <strong>注意：</strong>格式可能为webm、m4a等，具体取决于源网站
                    `;
                    // 更新按钮文字为原始格式
                    this.downloadBtn.innerHTML = '🎯 下载原始音频';
                } else {
                    // 其他格式时显示质量选择和额外选项
                    this.audioQualityContainer.style.display = 'block';
                    document.querySelector('.audio-extras').style.display = 'flex';
                    this.formatInfoText.innerHTML = `
                        🎯 <strong>语音转文字优化：</strong>MP3格式已针对语音识别优化，质量完全满足Whisper等AI模型需求<br>
                        📱 <strong>兼容性：</strong>MP3通用性最好，M4A适合苹果生态，WAV文件较大但无损<br>
                        📝 <strong>提示：</strong>勾选元数据可保留标题、作者等信息，封面对语音转文字无影响
                    `;
                    // 更新按钮文字为具体格式
                    const formatUpper = format.toUpperCase();
                    this.downloadBtn.innerHTML = `🎵 下载${formatUpper}音频`;
                }
            }
            
            handleVideoFormatChange(format) {
                if (format === 'original') {
                    this.videoFormatInfo.innerHTML = `
                        🎯 <strong>原始格式模式：</strong>下载视频的原始格式，不进行转换<br>
                        ⚡ <strong>优势：</strong>下载速度最快，保持原始画质，文件大小最优<br>
                        📝 <strong>格式：</strong>通常为webm或mp4，具体取决于视频源
                    `;
                } else {
                    this.videoFormatInfo.innerHTML = `
                        🎯 <strong>格式转换：</strong>将视频转换为${format.toUpperCase()}格式<br>
                        📱 <strong>兼容性：</strong>MP4兼容性最好，MKV支持高级特性，AVI传统兼容<br>
                        ⚠️ <strong>注意：</strong>转换会增加处理时间，但提供更好的兼容性
                    `;
                }
            }
            
            getDownloadOptions() {
                const downloadType = document.querySelector('input[name="downloadType"]:checked').value;
                const downloaderType = document.querySelector('input[name="downloaderType"]:checked').value;
                
                const options = {
                    type: downloadType,
                    url: this.urlInput.value.trim(),
                    session_id: this.sessionId,
                    downloader: downloaderType  // 新增下载器选择
                };
                
                if (downloadType === 'video') {
                    options.video_quality = this.videoQuality.value;
                    options.video_format = this.videoFormat.value;
                } else {
                    options.audio_format = this.audioFormat.value;
                    if (this.audioFormat.value !== 'original') {
                        options.audio_quality = this.audioQuality.value;
                        options.embed_metadata = this.embedMetadata.checked;
                        options.embed_thumbnail = this.embedThumbnail.checked;
                    }
                }
                
                return options;
            }
            
            updateProgress(data) {
                const handlers = {
                    'starting': () => this.handleProgressStart(data),
                    'downloading': () => this.handleProgressUpdate(data),
                    'finished': () => this.handleProgressComplete(data),
                    'error': () => this.handleProgressError(data)
                };
                
                const handler = handlers[data.status];
                if (handler) handler();
            }
            
            handleProgressStart(data) {
                this.showProgressContainer();
                const icon = data.type === 'audio' ? '🎵' : '📹';
                this.videoTitle.innerHTML = `<span style="color: #667eea;">${icon}</span> ${this.escapeHtml(data.title)}`;
                this.resetProgress();
                this.hideMessage();
            }
            
            handleProgressUpdate(data) {
                this.showProgressContainer();
                this.updateProgressBar(data);
            }
            
            handleProgressComplete(data) {
                this.completeProgress(data);
            }
            
            handleProgressError(data) {
                this.errorProgress(data);
            }
            
            showProgressContainer() {
                this.progressContainer.style.display = 'block';
                this.progressContainer.classList.add('show');
                this.progressContainer.offsetHeight; // 强制重新渲染
            }
            
            hideProgressContainer() {
                this.progressContainer.classList.remove('show');
                setTimeout(() => {
                    this.progressContainer.style.display = 'none';
                }, 500);
            }
            
            resetProgress() {
                Object.assign(this.progressBarFill.style, { width: '0%' });
                this.progressBarText.textContent = '准备中...';
                this.progressPercentage.textContent = '0%';
                this.progressPercentage.style.color = '#333';
                this.progressSize.textContent = '0 B / 0 B';
                this.progressSpeed.textContent = '0 B/s';
                this.progressEta.textContent = '--';
            }
            
            updateProgressBar(data) {
                const percentage = parseFloat(data.percentage);
                
                this.progressBarFill.style.width = percentage + '%';
                this.progressPercentage.textContent = percentage.toFixed(1) + '%';
                this.progressBarText.textContent = percentage.toFixed(1) + '%';
                this.progressSize.textContent = `${data.downloaded} / ${data.total}`;
                this.progressSpeed.textContent = data.speed || '0 B/s';
                this.progressEta.textContent = data.eta || '--';
                
                // 显示片段下载进度（如果有）
                if (data.fragments_downloaded && data.total_fragments) {
                    const fragmentProgress = `片段 ${data.fragments_downloaded}/${data.total_fragments}`;
                    this.progressBarText.textContent = `${percentage.toFixed(1)}% (${fragmentProgress})`;
                }
                
                this.updateProgressColor(percentage);
            }
            
            updateProgressColor(percentage) {
                const colorMap = [
                    { threshold: 90, color: '#28a745', bg: 'linear-gradient(45deg, #28a745, #20c997)' },
                    { threshold: 75, color: '#20c997', bg: 'linear-gradient(45deg, #20c997, #17a2b8)' },
                    { threshold: 50, color: '#17a2b8', bg: 'linear-gradient(45deg, #17a2b8, #6f42c1)' },
                    { threshold: 25, color: '#6f42c1', bg: 'linear-gradient(45deg, #6f42c1, #e83e8c)' },
                    { threshold: 0, color: '#fd7e14', bg: 'linear-gradient(45deg, #fd7e14, #dc3545)' }
                ];
                
                const colorConfig = colorMap.find(config => percentage > config.threshold);
                this.progressPercentage.style.color = colorConfig.color;
                this.progressBarFill.style.background = colorConfig.bg;
            }
            
            completeProgress(data) {
                this.showProgressContainer();
                this.setProgressComplete();
                
                const message = this.buildCompleteMessage(data);
                this.showMessage('✅ ' + message, 'success');
                
                this.resetDownloadState();
                this.loadDownloadsList();
                
                setTimeout(() => this.hideProgressContainer(), 3000);
            }
            
            setProgressComplete() {
                this.progressBarFill.style.width = '100%';
                this.progressBarText.textContent = '下载完成!';
                this.progressPercentage.textContent = '100%';
                this.progressPercentage.style.color = '#28a745';
                this.progressBarFill.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                this.progressContainer.style.borderColor = '#28a745';
            }
            
            buildCompleteMessage(data) {
                if (data.message) {
                    // 如果是原始格式，强调速度优势
                    if (data.is_original) {
                        return data.message + " (🚀 极速模式)";
                    }
                    return data.message;
                }
                
                const downloadType = data.download_type || 'video';
                const icon = downloadType === 'audio' ? '🎵' : '🎥';
                const typeText = downloadType === 'audio' ? '音频' : '视频';
                const speedText = data.is_original ? ' (🚀 极速模式)' : '';
                return `${icon} ${typeText}下载完成!${speedText}`;
            }
            
            errorProgress(data) {
                this.progressBarFill.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
                this.progressContainer.style.borderColor = '#dc3545';
                this.progressBarText.textContent = '下载失败';
                this.progressPercentage.style.color = '#dc3545';
                
                this.showMessage('❌ ' + data.message, 'error');
                this.resetDownloadState();
                
                setTimeout(() => this.hideProgressContainer(), 1000);
            }
            
            async startDownload() {
                const url = this.urlInput.value.trim();
                
                if (!this.validateUrl(url)) return;
                
                const downloadOptions = this.getDownloadOptions();
                this.setDownloadingState(downloadOptions.type, downloadOptions.downloader);
                
                try {
                    await this.sendDownloadRequest(downloadOptions);
                    this.setupDownloadTimeout();
                } catch (error) {
                    console.error('Download request failed:', error);
                    this.showMessage('❌ ' + error.message, 'error');
                    this.resetDownloadState();
                    this.hideProgressContainer();
                }
            }
            
            validateUrl(url) {
                if (!url) {
                    this.showMessage('❌ 请输入视频URL', 'error');
                    return false;
                }
                
                if (!this.isValidUrl(url)) {
                    this.showMessage('❌ 请输入有效的URL', 'error');
                    return false;
                }
                
                return true;
            }
            
            setDownloadingState(type, downloader) {
                this.isDownloading = true;
                this.downloadBtn.disabled = true;
                
                const icon = type === 'video' ? '🎥' : '🎯';
                const downloaderText = downloader === 'aria2c' ? '(aria2c加速)' : '(yt-dlp优化)';
                const text = type === 'video' ? `下载视频中...${downloaderText}` : `下载原始音频中...${downloaderText}`;
                this.downloadBtn.textContent = `${icon} ${text}`;
                this.downloadBtn.style.background = '#ccc';
                this.downloadBtn.style.cursor = 'not-allowed';
                
                this.hideMessage();
                this.showProgressContainer();
                
                const typeText = type === 'video' ? '视频' : '音频';
                this.videoTitle.innerHTML = `<span style="color: #667eea;">${icon}</span> 正在解析${typeText}信息...`;
                this.resetProgress();
                this.progressBarText.textContent = '正在连接...';
            }
            
            async sendDownloadRequest(options) {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(options)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '请求失败');
                }
                
                console.log('Download request sent successfully:', data);
                this.progressBarText.textContent = '请求已发送，等待响应...';
            }
            
            setupDownloadTimeout() {
                this.downloadTimeout = setTimeout(() => {
                    if (this.isDownloading) {
                        console.warn('No WebSocket response received');
                        this.progressBarText.textContent = '下载中... (如果长时间无响应请刷新页面)';
                    }
                }, 30000);
            }
            
            resetDownloadState() {
                this.isDownloading = false;
                this.downloadBtn.disabled = false;
                
                // 根据当前选择的类型设置按钮文字
                const currentType = document.querySelector('input[name="downloadType"]:checked').value;
                const icon = currentType === 'video' ? '🎥' : '🎯';
                const text = currentType === 'video' ? '下载视频' : '下载原始音频';
                this.downloadBtn.textContent = `${icon} ${text}`;
                
                this.downloadBtn.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
                this.downloadBtn.style.cursor = 'pointer';
                
                if (this.downloadTimeout) {
                    clearTimeout(this.downloadTimeout);
                    this.downloadTimeout = null;
                }
            }
            
            isValidUrl(string) {
                try {
                    const url = new URL(string);
                    return ['http:', 'https:'].includes(url.protocol);
                } catch {
                    return false;
                }
            }
            
            showMessage(text, type) {
                this.message.textContent = text;
                this.message.className = `message ${type} show`;
                setTimeout(() => this.hideMessage(), 5000);
            }
            
            hideMessage() {
                this.message.classList.remove('show');
            }
            
            async loadDownloadsList() {
                try {
                    this.downloadsList.innerHTML = '<div class="loading">正在加载下载列表...</div>';
                    
                    const response = await fetch('/api/downloads');
                    if (!response.ok) throw new Error('获取下载列表失败');
                    
                    const files = await response.json();
                    this.allFiles = files;
                    this.filterAndDisplayFiles();
                } catch (error) {
                    console.error('Error loading downloads:', error);
                    this.downloadsList.innerHTML = `
                        <div class="empty-state">
                            <p>❌ 加载失败: ${error.message}</p>
                        </div>
                    `;
                }
            }
            
            filterAndDisplayFiles() {
                const filterType = this.fileTypeFilter.value;
                let filteredFiles = [...this.allFiles];
                
                if (filterType !== 'all') {
                    filteredFiles = this.allFiles.filter(file => {
                        const fileCategory = this.categorizeFile(file);
                        return fileCategory === filterType;
                    });
                }
                
                this.renderDownloadsList(filteredFiles);
            }
            
            categorizeFile(file) {
                const ext = file.name.split('.').pop().toLowerCase();
                const audioExts = ['mp3', 'm4a', 'wav', 'aac', 'ogg', 'opus', 'flac'];
                const videoExts = ['mp4', 'mkv', 'avi', 'mov', 'wmv', 'flv', 'webm', 'm4v'];
                const originalAudioExts = ['webm', 'opus', 'm4a']; // 常见的原始音频格式
                const originalVideoExts = ['webm', 'mp4']; // 常见的原始视频格式
                
                if (audioExts.includes(ext)) {
                    // 判断是否为原始格式：通过文件名或扩展名特征
                    if (originalAudioExts.includes(ext) || file.name.includes('[original]')) {
                        return 'audio_original';
                    } else {
                        return 'audio_converted';
                    }
                } else if (videoExts.includes(ext)) {
                    // 判断是否为原始视频格式
                    if (file.name.includes('[original]') || 
                        (originalVideoExts.includes(ext) && !file.name.includes('converted'))) {
                        return 'video_original';
                    } else {
                        return 'video_converted';
                    }
                }
                
                return 'unknown';
            }
            
            renderDownloadsList(files) {
                if (files.length === 0) {
                    const filterType = this.fileTypeFilter.value;
                    const emptyMessages = {
                        'all': '📁 暂无下载文件',
                        'audio_converted': '🎵 暂无转换后的音频文件',
                        'audio_original': '🎯 暂无原始格式音频文件',
                        'video_converted': '🎬 暂无转换后的视频文件',
                        'video_original': '🎯 暂无原始格式视频文件'
                    };
                    
                    this.downloadsList.innerHTML = `
                        <div class="empty-state">
                            <p>${emptyMessages[filterType] || '📁 暂无符合条件的文件'}</p>
                            <p>输入视频链接开始下载吧！</p>
                        </div>
                    `;
                    return;
                }
                
                const html = files.map(file => this.renderFileItem(file)).join('');
                this.downloadsList.innerHTML = html;
            }
            
            renderFileItem(file) {
                const fileIcon = file.file_icon || this.getFileIcon(file.name);
                const fileType = file.file_type || this.getFileType(file.name);
                const category = this.categorizeFile(file);
                
                const typeLabels = {
                    'audio_converted': '转换音频',
                    'audio_original': '原始音频',
                    'video_converted': '转换视频',
                    'video_original': '原始视频',
                    'unknown': '文件'
                };
                
                const typeLabel = typeLabels[category] || '文件';
                
                return `
                    <div class="download-item">
                        <div class="file-info">
                            <div class="file-name">
                                ${fileIcon} ${this.escapeHtml(file.name)}
                                <span class="file-type-badge">${typeLabel}</span>
                            </div>
                            <div class="file-meta">
                                <span>📁 大小: ${file.size_formatted}</span>
                                <span>📅 时间: ${file.modified}</span>
                            </div>
                        </div>
                        <a href="${file.download_url}" class="download-link" download>
                            📥 下载
                        </a>
                    </div>
                `;
            }
            
            getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const icons = {
                    audio: ['mp3', 'm4a', 'wav', 'aac', 'ogg', 'opus', 'flac', 'webm'],
                    video: ['mp4', 'mkv', 'avi', 'mov', 'wmv', 'flv', 'webm', 'm4v']
                };
                
                if (icons.audio.includes(ext)) return '🎵';
                if (icons.video.includes(ext)) return '🎥';
                return '📄';
            }
            
            getFileType(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const types = {
                    audio: ['mp3', 'm4a', 'wav', 'aac', 'ogg', 'opus', 'flac', 'webm'],
                    video: ['mp4', 'mkv', 'avi', 'mov', 'wmv', 'flv', 'webm', 'm4v']
                };
                
                if (types.audio.includes(ext)) return 'audio';
                if (types.video.includes(ext)) return 'video';
                return 'unknown';
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            async testAria2c() {
                try {
                    this.testAria2cBtn.disabled = true;
                    this.testAria2cBtn.textContent = '🔧 测试中...';
                    
                    const response = await fetch('/api/test-aria2c');
                    const data = await response.json();
                    
                    let message = '';
                    let alertClass = '';
                    
                    switch (data.status) {
                        case 'working':
                            message = `✅ ${data.message}`;
                            alertClass = 'success';
                            break;
                        case 'available_but_not_used':
                            message = `✅ ${data.message}`;
                            alertClass = 'success';
                            break;
                        case 'not_found':
                            message = `❌ ${data.message}`;
                            alertClass = 'error';
                            break;
                        case 'error':
                        case 'timeout':
                        case 'exception':
                            message = `⚠️ ${data.message}`;
                            alertClass = 'error';
                            break;
                        default:
                            message = '❓ 未知状态';
                            alertClass = 'error';
                    }
                    
                    this.showMessage(message, alertClass);
                    
                } catch (error) {
                    console.error('测试aria2c失败:', error);
                    this.showMessage('❌ 测试aria2c时发生错误', 'error');
                } finally {
                    this.testAria2cBtn.disabled = false;
                    this.testAria2cBtn.textContent = '🔧 测试aria2c';
                }
            }
            
            async showPerformanceModal() {
                try {
                    // 获取性能状态数据
                    const response = await fetch('/api/performance-status');
                    if (response.ok) {
                        const data = await response.json();
                        this.updatePerformanceModal(data);
                    }
                } catch (error) {
                    console.error('Failed to load performance status:', error);
                }
                
                // 显示模态框
                const modal = document.getElementById('performanceModal');
                modal.classList.add('show');
            }
            
            updatePerformanceModal(data) {
                const config = data.performance_config;
                
                // 更新统计数据
                document.getElementById('concurrentFragments').textContent = `${config.concurrent_fragments} 线程`;
                document.getElementById('retryCount').textContent = `${config.retries} 次`;
                document.getElementById('bufferSize').textContent = `${Math.round(config.buffersize/1024)}KB`;
                document.getElementById('chunkSize').textContent = `${Math.round(config.http_chunk_size/1024/1024)}MB`;
                document.getElementById('sleepRequests').textContent = `${config.sleep_requests}秒`;
                
                // 更新优化特性列表
                const featuresContainer = document.getElementById('optimizationFeatures');